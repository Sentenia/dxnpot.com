<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DXNPot â€” Burn XEN Â· Mint & Stake DXN</title>
  <meta name="description" content="DXNPot â€” Burn XEN to mint DXN, auto-stake, claim ETH fees, and manage DXN staking on Ethereum.">
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- DXNPot fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#050814;

      --cardTop: rgba(13, 19, 34, .78);
      --cardBot: rgba(2, 6, 23, .72);

      --stroke: rgba(255,255,255,.085);
      --stroke2: rgba(255,255,255,.06);

      --txt:#e5e7eb;
      --muted:#a3aab7;
      --muted2:#7c8596;

      --yellow:#facc15;
      --yellow2:#f59e0b;
      --black:#000;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 28px rgba(0,0,0,.35);

      --r16: 18px;
      --r12: 14px;
      --r10: 12px;

      /* Burn-page legacy colors kept */
      --line: rgba(148,163,184,.22);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--txt);
      background: url("dxn-bg.png") center / cover no-repeat fixed;
      padding: 22px 22px;
    }

    body:before{
      content:"";
      position:fixed; inset:-200px -200px auto -200px;
      height:420px;
      background: radial-gradient(closest-side, rgba(250,204,21,.16), transparent 65%);
      pointer-events:none;
      z-index:-1;
      filter: blur(2px);
    }

    .mono{ font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    /* match DXNPot frame sizing */
    .frame{
      width: min(1440px, calc(100vw - 44px));
      max-width: 1440px;
      margin: 0 auto;
      padding: 20px;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(2,6,23,.38);
      box-shadow: var(--shadow), inset 0 0 0 1px rgba(255,255,255,.03);
      backdrop-filter: blur(12px);
      overflow: hidden;
      position: relative;
    }
    .frame::after{
      content:"";
      position:absolute;
      inset: 0;
      border-radius: 26px;
      pointer-events:none;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06),
        0 0 120px rgba(250,204,21,.18),
        inset 0 0 60px rgba(250,204,21,.08);
    }

    /* DXNPot top bar */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 18px;
      position: relative;
      z-index: 2;
    }

    .tabs{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .tab{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 40px;
      padding: 0 14px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      color: var(--txt);
      text-decoration:none;
      font-weight: 800;
      letter-spacing: .2px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
    }
    .tab:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.14); }
    .tab.active{
      background: linear-gradient(180deg, var(--yellow), var(--yellow2));
      color: #000;
      border: 0;
      box-shadow: 0 10px 22px rgba(250,204,21,.18);
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      min-height: 44px;
      white-space:nowrap;
    }

    .dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: #60a5fa;
      box-shadow: 0 0 14px rgba(96,165,250,.45);
    }

    .btn-yellow{
      background: linear-gradient(180deg, var(--yellow), var(--yellow2));
      border: 0;
      color: var(--black);
      font-weight: 900;
      border-radius: 12px;
      padding: 10px 14px;
      cursor:pointer;
      height: 40px;
      box-shadow: 0 10px 22px rgba(250,204,21,.18);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, opacity .12s ease;
    }
    .btn-yellow:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btn-yellow:active{ transform: translateY(0px); filter: brightness(.98); }
    .btn-yellow[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

    /* Burn page layout */
    .title{
      text-align:center;
      font-size: 30px;
      font-weight: 900;
      letter-spacing: -0.3px;
      margin: 16px 0 10px;
      position: relative;
      z-index: 2;
    }

    .subline{
      display:flex;
      justify-content:center;
      gap: 40px;
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 18px;
      flex-wrap:wrap;
      position: relative;
      z-index: 2;
    }

    .subline b{ color: var(--yellow); font-weight:900; }

    .card{
      background: linear-gradient(180deg, var(--cardTop), var(--cardBot));
      border: 1px solid var(--stroke);
      border-radius: var(--r16);
      padding: 18px;
      box-shadow: var(--shadow2), inset 0 0 0 1px rgba(255,255,255,.03);
      margin-top: 16px;
      position: relative;
      z-index: 2;
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 12px;
      gap: 10px;
      flex-wrap:wrap;
    }

    .card-header .label{
      font-size: 16px;
      font-weight: 900;
      letter-spacing:.2px;
      color: var(--txt);
    }

    .card-header .maxhint{
      font-size: 12px;
      color: var(--muted2);
      letter-spacing:.3px;
      font-weight: 800;
    }
    .card-header .maxhint b{ color: var(--yellow); }

    .controls{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .input{
      width: 82px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.42);
      color: var(--txt);
      text-align:center;
      font-size: 16px;
      font-weight: 800;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
      transition: border-color .12s ease, transform .12s ease;
    }
    .input:focus{ border-color: rgba(250,204,21,.35); transform: translateY(-1px); }

    .xenbox{
      flex: 1 1 220px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.42);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
      min-width: 220px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }

    .smallnote{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 650;
    }
    .smallnote.row-between{
      display:flex;
      justify-content: space-between;
      align-items:center;
      width:100%;
      gap: 12px;
      flex-wrap:wrap;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 12px 0 12px;
    }

    .lines{
      font-size: 14px;
      color: var(--muted);
      line-height: 1.9;
      font-weight: 650;
    }
    .lines .v{ color: var(--yellow); font-weight: 900; }

    .burnbtn{
      margin-top: 14px;
      width: 100%;
      height: 56px;
      border-radius: 14px;
      font-size: 18px;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    }

    .rows{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      position: relative;
      z-index: 2;
    }

    .rowcard{
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      border-radius: 14px;
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 14px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }

    .rowcard .left{
      font-size: 16px;
      color: var(--txt);
      font-weight: 750;
    }
    .rowcard .left b{ color: var(--yellow); font-weight: 900; }

    .row-actions{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .sub-under{
      margin-top: 8px;
      text-align:right;
      color: var(--muted2);
      font-size: 13px;
      font-weight: 650;
    }

    .bottomlinks{
      text-align:center;
      margin-top: 18px;
      color: var(--muted2);
      font-size: 13px;
      letter-spacing:.2px;
      width: 100%;
      position: relative;
      z-index: 2;
    }

    .bottomlinks a{
      color: var(--muted2);
      text-decoration:none;
      border-bottom: 1px solid rgba(148,163,184,.25);
      padding-bottom: 2px;
      font-weight: 650;
    }
    .bottomlinks a:hover{ color: var(--txt); border-bottom-color: rgba(229,231,235,.35); }

    .copy-pill{
      display:inline-block;
      margin-top:10px;
      padding:8px 12px;
      border-radius:999px;
      background: linear-gradient(180deg, var(--yellow), var(--yellow2));
      color:#000;
      font-weight:900;
      font-size:12px;
      letter-spacing:.2px;
      box-shadow: 0 10px 22px rgba(250,204,21,.18);
    }

    /* chain pill menu */
    .chain-pill{ position:relative; cursor:pointer; }
    .chain-menu{
      position:absolute;
      top: 52px;
      left: 0;
      width: 220px;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.03);
      z-index: 999;
    }
    .chain-item{
      width:100%;
      text-align:left;
      padding: 10px 12px;
      border:0;
      border-radius:10px;
      background: transparent;
      color: var(--txt);
      cursor:pointer;
      font-size: 14px;
      font-weight: 650;
    }
    .chain-item:hover{ background: rgba(255,255,255,.06); }

    .row-between{
      display:flex;
      justify-content: space-between;
      align-items:center;
    }

    .rowcard.stakeRow{ align-items:flex-start; }
    .rowcard.stakeRow .left{ flex: 1; }
    .rowcard.stakeRow .right{
      margin-left:auto;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
    }

    @media (max-width: 640px){
      .title{ font-size: 26px; }
      .xenbox{ min-width: 180px; }
    }
  </style>
</head>

<body>
  <div class="frame">

    <!-- DXNPot-style topbar w/ tabs -->
    <div class="topbar">
      <div class="tabs">
        <a class="tab" href="/pot/">DXN POT</a>
        <a class="tab active" href="/burn/">BURN XEN</a>
      </div>

      <!-- keep your chain pill -->
      <div class="pill chain-pill" id="chainPill">
        <span class="dot"></span>
        <span id="chainLabel" style="font-weight:800;">Ethereum</span>
        <span style="opacity:.75;font-weight:800;">â–¼</span>

        <div class="chain-menu" id="chainMenu" style="display:none;">
          <button class="chain-item" data-chain="eth">Ethereum</button>
          <button class="chain-item" data-chain="soon">More chains soon</button>
        </div>
      </div>

      <!-- wallet pill (same IDs preserved) -->
      <div class="pill">
        <span class="dot"></span>
        <span id="ethBal" class="mono" style="font-weight:800;">â€” ETH</span>
        <span id="addrShort" class="mono" style="opacity:.85;">Not connected</span>
        <button id="connectBtn" class="btn-yellow" style="height:40px;padding:0 12px;border-radius:12px;font-weight:900;">
          Connect
        </button>
      </div>
    </div>

    <!-- title -->
    <div class="title">Burn XEN / Mint DXN</div>

    <!-- cycle line -->
    <div class="subline">
      <div>Current Cycle: <b id="currentCycle">â€”</b></div>
      <div>DXN Minted This Cycle: <b id="dxnMintedCycle">â€”</b></div>
    </div>

    <!-- burn card -->
    <div class="card">
      <div class="card-header">
        <div class="label">Burn Batches</div>
        <div class="maxhint">MAX: <b>10,000</b> BATCHES</div>
      </div>

      <div class="controls">
        <input id="batchInput" class="input mono" type="number" value="1" min="1" max="10000" />

        <button id="minusBtn" class="btn-yellow" style="height:44px;border-radius:14px;">âˆ’</button>

        <div class="xenbox mono">
          <span id="xenAmount">2,500,000</span> <span style="opacity:.85;">XEN</span>
        </div>

        <button id="plusBtn" class="btn-yellow" style="height:44px;border-radius:14px;">+</button>

        <button id="maxBtn" class="btn-yellow" style="height:44px;border-radius:14px;">â¬† Max</button>
      </div>

      <div class="smallnote row-between">
        <span>1 Batch = 2,500,000 XEN</span>
        <span>Your XEN: <b id="yourXen">â€”</b></span>
      </div>

      <div class="divider"></div>

      <div class="lines">
        Protocol Fee : <span id="pf" class="v">~</span><br />
        Total Transaction Cost: <span id="ttc" class="v">~</span><br />
        Total XEN Burned : <span id="totalXenBurned" class="v">2,500,000</span>
      </div>

      <button class="btn-yellow burnbtn">ðŸ”¥ Burn XEN</button>
    </div>

    <!-- rows -->
    <div class="rows">
      <div class="rowcard">
        <div class="left">
          Auto-staked DXN: <b id="autoDxnVal">â€”</b> <span style="opacity:.85;">DXN</span>
        </div>
        <button id="claimDxnBtn" class="btn-yellow" style="min-width:140px;">Claim</button>
      </div>

      <div class="rowcard">
        <div class="left">
          Claimable ETH: <b id="claimableEthVal">â€”</b> <span style="opacity:.85;">ETH</span>
        </div>
        <button id="claimEthBtn" class="btn-yellow" style="min-width:140px;">Claim</button>
      </div>

      <div class="rowcard stakeRow">
        <div class="left" style="padding-top:2px; line-height:1.15;">
          <div>
            Total Staked:
            <b id="totalStakedVal" class="tip" data-tip="Available to withdraw this cycle">â€”</b>
            <span style="opacity:.85;">DXN</span>
          </div>

          <div style="margin-top:6px; color:var(--muted2); font-size:14px;">
            Total Pending:
            <b id="pendingStakedVal" class="tip" data-tip="Locked until next cycle">â€”</b>
            <span style="opacity:.85;">DXN</span>
          </div>
        </div>

        <div class="right">
          <div class="row-actions">
            <input id="stakeAmt" class="input mono" type="number" placeholder="0.0" min="0" step="any" style="width:140px;" />
            <button id="stakeBtn" class="btn-yellow" style="min-width:130px;">Stake</button>
            <button id="unstakeBtn" class="btn-yellow" style="min-width:130px;">Unstake</button>
          </div>
          <div class="sub-under">Your DXN: <span id="yourDxnBal" class="mono">â€”</span> DXN</div>
        </div>
      </div>
    </div>

    <!-- bottom contract links -->
    <div class="bottomlinks">
      <div class="contract-links">
        <a href="#" id="copyXen">XEN Contract</a>
        &nbsp; | &nbsp;
        <a href="#" id="copyDxn">DXN Contract</a>
      </div>

      <div id="copyMsg" class="copy-pill" style="display:none;"></div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>

  <!-- YOUR ORIGINAL JS (UNCHANGED) -->
  <script>
  const ERC20_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function allowance(address owner, address spender) view returns (uint256)",
    "function approve(address spender, uint256 amount) returns (bool)",
    "function decimals() view returns (uint8)"
  ];

  function wireClaimButtons() {
    const claimDxnBtn = document.getElementById("claimDxnBtn");
    const claimEthBtn = document.getElementById("claimEthBtn");

    console.log("wireClaimButtons:", {
      claimDxnBtn: !!claimDxnBtn,
      claimEthBtn: !!claimEthBtn
    });

    if (claimDxnBtn && !claimDxnBtn.__wired) {
      claimDxnBtn.__wired = true;
      claimDxnBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        if (!signer) return;

        try {
          const gasPrice = await getLegacyGasPriceWei();
          const dbxenWrite = new ethers.Contract(DBXEN_ADDRESS, DBXEN_ABI, signer);

          const tx = await dbxenWrite.claimRewards({ gasPrice, type: 0 });
          await tx.wait();

          await loadClaimables();
        } catch (err) {
          console.log("CLAIM DXN ERROR:", err);
        }
      });
    }

    if (claimEthBtn && !claimEthBtn.__wired) {
      claimEthBtn.__wired = true;
      claimEthBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        if (!signer) return;

        try {
          const gasPrice = await getLegacyGasPriceWei();
          const dbxenWrite = new ethers.Contract(DBXEN_ADDRESS, DBXEN_ABI, signer);

          const tx = await dbxenWrite.claimFees({ gasPrice, type: 0 });
          await tx.wait();

          await loadClaimables();
        } catch (err) {
          console.log("CLAIM ETH ERROR:", err);
        }
      });
    }
  }

  const chainPill = document.getElementById("chainPill");
  const chainMenu = document.getElementById("chainMenu");
  const chainLabel = document.getElementById("chainLabel");

  chainPill.addEventListener("click", (e) => {
    e.stopPropagation();
    chainMenu.style.display = (chainMenu.style.display === "none") ? "block" : "none";
  });

  document.addEventListener("click", () => {
    chainMenu.style.display = "none";
  });

  document.querySelectorAll(".chain-item").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      chainLabel.textContent = btn.textContent;
      chainMenu.style.display = "none";
    });
  });

  const XEN_ADDRESS = "0x06450dee7fd2fb8e39061434babcfc05599a6fb8";
  const DXN_ADDRESS = "0x80f0c1c49891dcfdd40b6e0f960f84e6042bcb6f";

  const copyXen = document.getElementById("copyXen");
  const copyDxn = document.getElementById("copyDxn");
  const copyMsg = document.getElementById("copyMsg");

  function showCopied(text){
    copyMsg.textContent = text;
    copyMsg.style.display = "inline-block";
    copyMsg.style.opacity = "1";

    clearTimeout(window.__copyTimer);
    window.__copyTimer = setTimeout(() => {
      copyMsg.style.opacity = "0";
      setTimeout(() => { copyMsg.style.display = "none"; }, 250);
    }, 1200);
  }

  async function copyToClipboard(addr){
    try{
      await navigator.clipboard.writeText(addr);
      showCopied("Address copied to clipboard");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = addr;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      showCopied("Address copied to clipboard");
    }
  }

  copyXen.addEventListener("click", (e) => {
    e.preventDefault();
    copyToClipboard(XEN_ADDRESS);
  });

  copyDxn.addEventListener("click", (e) => {
    e.preventDefault();
    copyToClipboard(DXN_ADDRESS);
  });

  const XEN_PER_BATCH = 2500000;
  const MAX_BATCHES = 10000;

  const DBXEN_ADDRESS = "0xF5c80c305803280B587F8cabBcCdC4d9BF522AbD";

  const DBXEN_ABI = [
    "function burnBatch(uint256 batches) payable",
    "function claimFees()",
    "function claimRewards()",
    "function stake(uint256 amount)",
    "function unstake(uint256 amount)",
    "function MAX_BPS() view returns (uint256)",
    "function currentCycle() view returns (uint256)",
    "function getCurrentCycle() view returns (uint256)",
    "function currentCycleReward() view returns (uint256)",
    "function lastCycleReward() view returns (uint256)",
    "function rewardPerCycle(uint256) view returns (uint256)",
    "function accWithdrawableStake(address account) view returns (uint256)",
    "function pendingStake() view returns (uint256)",
    "function pendingStakeWithdrawal() view returns (uint256)",
    "function accRewards(address account) view returns (uint256)",
    "function getAccWithdrawableStake(address staker) view returns (uint256)",
    "function getUnclaimedRewards(address account) view returns (uint256)",
    "function getUnclaimedFees(address account) view returns (uint256)",
    "function calculateCycleReward() view returns (uint256)",
    "function dxnMintedInCycle(uint256 cycle) view returns (uint256)",
    "function accFirstStake(address) view returns (uint256)",
    "function accSecondStake(address) view returns (uint256)",
    "function accStakeCycle(address,uint256) view returns (uint256)",
    "function getUnclaimedRewards(address) view returns (uint256)",
    "function getUnclaimedFees(address) view returns (uint256)",
  ];

  const DBXEN_READER_ADDRESS = "0xf032f7FB8258728A1938473B2115BB163d5Da593";
  const DBXEN_READER_ABI = [
    "function dbxen() view returns (address)",
    "function calculateCycleReward() view returns (uint256)",
    "function getUnclaimedFees(address account) view returns (uint256)",
    "function getUnclaimedRewards(address account) view returns (uint256)",
    "function getAccWithdrawableStake(address) view returns (uint256)"
  ];

  const FEE_GAS_PAD = 39400n;
  const BATCH_SLOPE = 5n;

  const batchInput = document.getElementById("batchInput");
  const minusBtn = document.getElementById("minusBtn");
  const plusBtn = document.getElementById("plusBtn");
  const maxBtn = document.getElementById("maxBtn");

  const xenAmountEl = document.getElementById("xenAmount");
  const totalXenBurnedEl = document.getElementById("totalXenBurned");

  const pfEl = document.getElementById("pf");
  const ttcEl = document.getElementById("ttc");

  const connectBtn = document.getElementById("connectBtn");
  const addrShort = document.getElementById("addrShort");
  const ethBal = document.getElementById("ethBal");

  const burnBtn = document.querySelector(".burnbtn");

  let provider = null;
  let signer = null;
  let userAddress = null;
  let maxUnstakeWei = 0n;
  let __dxnWalletWei = 0n;
  let __dxnWithdrawableWei = 0n;

  function clampBatches(n) {
    n = Math.floor(Number(n || 1));
    if (n < 1) n = 1;
    if (n > MAX_BATCHES) n = MAX_BATCHES;
    return n;
  }

  function fmtInt(n) {
    return Number(n).toLocaleString("en-US");
  }

  function shortAddr(a) {
    return a ? (a.slice(0, 6) + "â€¦" + a.slice(-4)) : "Not connected";
  }

  function renderXen() {
    const b = clampBatches(batchInput.value);
    batchInput.value = b;

    const xen = b * XEN_PER_BATCH;
    xenAmountEl.textContent = fmtInt(xen);
    totalXenBurnedEl.textContent = fmtInt(xen);
  }

  async function connectWallet() {
    if (!window.ethereum) {
      return;
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();

    addrShort.textContent = shortAddr(userAddress);

    const balWei = await provider.getBalance(userAddress);
    ethBal.textContent = Number(ethers.formatEther(balWei)).toFixed(4) + " ETH";

    await refreshFees();
    await loadXenBalance();
    await loadCycleStats();
    await loadClaimables();
    await loadStakeInfo();

    wireClaimButtons();
  }

  async function loadStakeInfo() {
    const totalEl = document.getElementById("totalStakedVal");
    const pendingEl = document.getElementById("pendingStakedVal");
    const balEl = document.getElementById("yourDxnBal");

    if (totalEl) totalEl.textContent = "â€¦";
    if (pendingEl) pendingEl.textContent = "â€¦";
    if (balEl) balEl.textContent = "â€¦";

    if (!provider || !userAddress) {
      if (totalEl) totalEl.textContent = "â€”";
      if (pendingEl) pendingEl.textContent = "â€”";
      if (balEl) balEl.textContent = "â€”";
      return;
    }

    try {
      const dxn = new ethers.Contract(DXN_ADDRESS, ERC20_ABI, provider);
      const bal = await dxn.balanceOf(userAddress);

      __dxnWalletWei = bal;
      if (balEl) balEl.textContent = fmtDXN6(bal);

      const reader = new ethers.Contract(DBXEN_READER_ADDRESS, DBXEN_READER_ABI, provider);
      const withdrawable = await reader.getAccWithdrawableStake(userAddress);

      __dxnWithdrawableWei = withdrawable;
      maxUnstakeWei = withdrawable;

      const pending = 0n;

      if (totalEl) totalEl.textContent = fmtDXN6(withdrawable);
      if (pendingEl) pendingEl.textContent = fmtDXN6(pending);

    } catch (e) {
      console.log("loadStakeInfo failed:", e);
      if (totalEl) totalEl.textContent = "â€”";
      if (pendingEl) pendingEl.textContent = "â€”";
      if (balEl) balEl.textContent = "â€”";
    }
  }

  async function loadCycleStats() {
    const cycleEl = document.getElementById("currentCycle");
    const mintedEl = document.getElementById("dxnMintedCycle");

    if (cycleEl) cycleEl.textContent = "â€¦";
    if (mintedEl) mintedEl.textContent = "â€¦";

    if (!provider) {
      if (cycleEl) cycleEl.textContent = "â€”";
      if (mintedEl) mintedEl.textContent = "â€”";
      return;
    }

    try {
      const dbxen = new ethers.Contract(DBXEN_ADDRESS, DBXEN_ABI, provider);
      const cycle = await dbxen.currentCycle.staticCall();
      if (cycleEl) cycleEl.textContent = cycle.toString();
    } catch (e) {
      console.log("currentCycle() failed:", e);
      if (cycleEl) cycleEl.textContent = "â€”";
      if (mintedEl) mintedEl.textContent = "â€”";
      return;
    }

    try {
      const reader = new ethers.Contract(DBXEN_READER_ADDRESS, DBXEN_READER_ABI, provider);
      const main = await reader.dbxen();
      console.log("reader.dbxen() =>", main);

      const rewardWei = await reader.calculateCycleReward();
      if (mintedEl) mintedEl.textContent = fmtDXN6(rewardWei);
    } catch (e) {
      console.log("calculateCycleReward (reader) failed:", e);
      if (mintedEl) mintedEl.textContent = "â€”";
    }
  }

  async function loadClaimables() {
    const dxnEl = document.getElementById("autoDxnVal");
    const ethEl = document.getElementById("claimableEthVal");

    if (dxnEl) dxnEl.textContent = "â€¦";
    if (ethEl) ethEl.textContent = "â€¦";

    if (!provider || !userAddress) {
      if (dxnEl) dxnEl.textContent = "â€”";
      if (ethEl) ethEl.textContent = "â€”";
      return;
    }

    try {
      const reader = new ethers.Contract(DBXEN_READER_ADDRESS, DBXEN_READER_ABI, provider);

      const feesWei = await reader.getUnclaimedFees(userAddress);
      const rewardsWei = await reader.getUnclaimedRewards(userAddress);

      console.log("reader fees eth:", ethers.formatEther(feesWei));
      console.log("reader rewards dxn:", ethers.formatUnits(rewardsWei, 18));

      if (ethEl) ethEl.textContent = fmtETH6(feesWei);
      if (dxnEl) dxnEl.textContent = fmtDXN6(rewardsWei);

    } catch (e) {
      console.log("loadClaimables failed:", e);
      if (dxnEl) dxnEl.textContent = "â€”";
      if (ethEl) ethEl.textContent = "â€”";
    }
  }

  async function loadXenBalance(){
    const el = document.getElementById("yourXen");
    if (!el) return;

    el.textContent = "â€¦";

    try{
      if (!provider || !userAddress) { el.textContent = "â€”"; return; }

      const xen = new ethers.Contract(XEN_ADDRESS, ERC20_ABI, provider);
      const decimals = await xen.decimals();
      const bal = await xen.balanceOf(userAddress);

      el.textContent = Number(ethers.formatUnits(bal, decimals)).toLocaleString();
    }catch(err){
      console.log("XEN BAL ERROR:", err);
      el.textContent = "ERR";
    }
  }

  async function getGasPriceWei() {
    const hex = await provider.send("eth_gasPrice", []);
    return BigInt(hex);
  }

  async function calcDbxenFee(batches) {
    const dbxenRead = new ethers.Contract(DBXEN_ADDRESS, DBXEN_ABI, provider);
    const maxBps = await dbxenRead.MAX_BPS();
    const b = BigInt(batches);
    const discount = b * (maxBps - (BATCH_SLOPE * b));
    const gasPrice = await getGasPriceWei();
    if (!gasPrice) throw new Error("No gasPrice");
    let gasUsed;
    try {
      gasUsed = await dbxenRead.burnBatch.estimateGas(batches, { from: userAddress, value: 0n });
    } catch {
      gasUsed = 220000n;
    }

    const protocolFee =
      ((gasUsed + FEE_GAS_PAD) * gasPrice * discount) / maxBps;

    const totalCost = protocolFee + (gasUsed * gasPrice);

    return { protocolFee, totalCost };
  }

  function fmtEth(wei) {
    try {
      const s = ethers.formatEther(wei);
      const n = Number(s);
      if (!isFinite(n)) return "~";
      return n.toFixed(5);
    } catch {
      return "~";
    }
  }

  function fmtETH6(wei) {
    try {
      const s = ethers.formatEther(wei);
      const [i, d = ""] = s.split(".");
      return `${i}.${d.slice(0, 6).padEnd(6, "0")}`;
    } catch {
      return "~";
    }
  }

  function fmtDXN6(wei) {
    try {
      const s = ethers.formatUnits(wei, 18);
      const [i, d = ""] = s.split(".");
      return `${i}.${d.slice(0, 6).padEnd(6, "0")}`;
    } catch {
      return "~";
    }
  }

  async function refreshFees() {
    if (!provider) {
      pfEl.textContent = "~";
      ttcEl.textContent = "~";
      return;
    }

    try {
      const b = clampBatches(batchInput.value);
      const { protocolFee, totalCost } = await calcDbxenFee(b);

      pfEl.textContent = "~ " + fmtEth(protocolFee) + " ETH";
      ttcEl.textContent = "~ " + fmtEth(totalCost) + " ETH";

      burnBtn.disabled = false;
      burnBtn.style.opacity = "1";
    } catch (e) {
      console.log("refreshFees failed:", e);
      pfEl.textContent = "~";
      ttcEl.textContent = "~";
      burnBtn.disabled = true;
      burnBtn.style.opacity = "0.6";
    }
  }

  async function burnXenNow() {
    if (!provider || !signer) { alert("Connect wallet first"); return; }

    const b = clampBatches(batchInput.value);
    const gasPrice = await getLegacyGasPriceWei();

    let gasUsed;
    try {
      const dbxenRead = new ethers.Contract(DBXEN_ADDRESS, DBXEN_ABI, provider);
      gasUsed = await dbxenRead.burnBatch.estimateGas(b, { value: 0n });
    } catch {
      gasUsed = 220000n;
    }

    const maxBps = 100000n;
    const discount = BigInt(b) * (maxBps - (5n * BigInt(b)));
    const protocolFee = ((gasUsed + 39400n) * gasPrice * discount) / maxBps;

    const valueToSend = (protocolFee * 130n) / 100n;

    const dbxenWrite = new ethers.Contract(DBXEN_ADDRESS, DBXEN_ABI, signer);

    const tx = await dbxenWrite.burnBatch(b, {
      value: valueToSend,
      gasPrice: gasPrice,
      type: 0
    });

    await tx.wait();
    await loadStakeInfo();
    setTimeout(loadStakeInfo, 2500);
  }

  async function getLegacyGasPriceWei() {
    const hex = await provider.send("eth_gasPrice", []);
    return BigInt(hex);
  }

  function parseDxnAmount(v) {
    const s = String(v || "").trim();
    if (!s) return 0n;
    return ethers.parseUnits(s, 18);
  }

  const stakeBtn = document.getElementById("stakeBtn");
  const unstakeBtn = document.getElementById("unstakeBtn");
  const stakeAmt = document.getElementById("stakeAmt");

  if (stakeBtn) {
    stakeBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      if (!signer) return;

      try {
        const amtWei = parseDxnAmount(stakeAmt.value);
        if (amtWei <= 0n) {
          const fill = __dxnWalletWei;
          stakeAmt.value = fill > 0n ? ethers.formatUnits(fill, 18) : "";
          return;
        }

        const dxn = new ethers.Contract(DXN_ADDRESS, ERC20_ABI, signer);
        const allowance = await dxn.allowance(userAddress, DBXEN_ADDRESS);

        if (allowance < amtWei) {
          const MAX = (2n ** 256n) - 1n;
          const txA = await dxn.approve(DBXEN_ADDRESS, MAX);
          await txA.wait();
        }

        const gasPrice = await getLegacyGasPriceWei();
        const dbxen = new ethers.Contract(DBXEN_ADDRESS, DBXEN_ABI, signer);

        const tx = await dbxen.stake(amtWei, {
          gasPrice,
          type: 0,
          gasLimit: 250000n
        });

        await tx.wait();
        await loadStakeInfo();

      } catch (err) {
        console.log("STAKE ERROR:", err);
      }
    });
  }

  if (unstakeBtn) {
    unstakeBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      if (!signer) return;

      try {
        const amtWei = parseDxnAmount(stakeAmt.value);
        if (amtWei <= 0n) {
          const fill = __dxnWithdrawableWei;
          stakeAmt.value = fill > 0n ? ethers.formatUnits(fill, 18) : "";
          return;
        }

        const gasPrice = await getLegacyGasPriceWei();
        const dbxen = new ethers.Contract(DBXEN_ADDRESS, DBXEN_ABI, signer);

        const tx = await dbxen.unstake(amtWei, { gasPrice, type: 0 });
        await tx.wait();

        await loadStakeInfo();
      } catch (err) {
        console.log("UNSTAKE ERROR:", err);
      }
    });
  }

  connectBtn.addEventListener("click", connectWallet);

  minusBtn.addEventListener("click", async () => {
    batchInput.value = clampBatches(Number(batchInput.value) - 1);
    renderXen();
    await refreshFees();
  });

  plusBtn.addEventListener("click", async () => {
    batchInput.value = clampBatches(Number(batchInput.value) + 1);
    renderXen();
    await refreshFees();
  });

  maxBtn.addEventListener("click", async () => {
    batchInput.value = MAX_BATCHES;
    renderXen();
    await refreshFees();
  });

  batchInput.addEventListener("input", async () => {
    renderXen();
    await refreshFees();
  });

  burnBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    if (!provider || !signer) {
      return;
    }

    const b = clampBatches(batchInput.value);

    try {
      const xen = new ethers.Contract(XEN_ADDRESS, ERC20_ABI, signer);
      const needed = BigInt(b) * BigInt(XEN_PER_BATCH);

      const allowance = await xen.allowance(userAddress, DBXEN_ADDRESS);

      if (allowance < needed) {
        const MAX = (2n ** 256n) - 1n;

        const tx1 = await xen.approve(DBXEN_ADDRESS, MAX);
        await tx1.wait();
      }

      await burnXenNow();
    } catch (err) {
      console.log("BURN FLOW ERROR:", err);
    }
  });

  wireClaimButtons();

  burnBtn.disabled = true;
  burnBtn.style.opacity = "0.6";
  renderXen();
  refreshFees();
  </script>
</body>
</html>
